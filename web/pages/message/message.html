<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>TimeMachine - Rowenci</title>
    <link rel="stylesheet" href="../../js/layui/css/layui.css">
</head>

<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">


        <div class="layui-header">
            <div class="layui-logo">TimeMachine</div>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item">
                    <a href="javascript:;">
                        <img id="head_image" src="" class="layui-nav-img">
                        <span id="username"></span>
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="../user/userinfo.html">基本资料</a></dd>
                        <dd><a href="../user/securityinfo.html">安全设置</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="" onclick="logout()">退出</a></li>
            </ul>
        </div>


        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <ul class="layui-nav layui-nav-tree" lay-filter="test">
                    <li class="layui-nav-item"><a href="../public_area.html">公共区域</a></li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a class="" href="javascript:;">我的信件</a>
                        <dl class="layui-nav-child">
                            <dd class="layui-this"><a href="javascript:;">写信件</a></dd>
                            <dd><a href="./list.html">信件列表</a></dd>
                            <dd><a href="./public_list.html">公开信件</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">我的喜欢</a>
                        <dl class="layui-nav-child">
                            <dd><a href="../myfavorite/good_list.html">点赞列表</a></dd>
                            <dd><a href="../myfavorite/favorite_list.html">收藏列表</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item"><a href="../user/vip.html">会员中心</a></li>
                </ul>
            </div>
        </div>

        <div class="layui-body">
            <!-- 内容主体区域 -->
            <div class="layui-form-item" style="margin-top: 15px;">
                <label class="layui-form-label">信件标题：</label>
                <div class="layui-input-block">
                    <input id="title" type="text" name="title" lay-verify="title" autocomplete="off"
                        placeholder="给未来的一封信" class="layui-input">
                </div>
            </div>
            <textarea id="message" style="display: none;"></textarea>
            <div id="options">
                <fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px; height: 250px;">
                    <legend>信件选项</legend>
                    <div class="layui-form">
                        <div id="time" style="margin: 10px 0 0 25px; display: inline;">
                            发送至 ：
                            <input id="week" type="radio" name="time" value="week" title="一周后" checked>
                            <input id="month" type="radio" name="time" value="month" title="一月后">
                            <input id="three_month" type="radio" name="time" value="three_month" title="三月后">
                            <input id="half_year" type="radio" name="time" value="half_year" title="半年后">
                            <input id="year" type="radio" name="time" value="year" title="一年后">
                            <button id="show_vip_option" onclick="show_vip_option()" type="button"
                                class="layui-btn">会员选项</button>
                        </div>
                        <div id="vip_time" style="margin: 10px 0 10px 0; display: none;" class="layui-inline">
                            <label class="layui-form-label">发送至 ：</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="vip_send" placeholder="yyyy年MM月dd日">
                            </div>
                            <button onclick="back_vip_option()" style="margin-left: 25px;" type="button"
                                class="layui-btn">返回</button>
                        </div>
                        </br>
                        <div class="layui-inline" style="margin-top: 10px;">
                            <label class="layui-form-label">邮箱地址：</label>
                            <div class="layui-input-inline">
                                <input id="email" type="email" name="email" lay-verify="email" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                        </br>
                        </br>
                        <div id="is_public" style="margin-left: 25px;">
                            <input type="checkbox" name="is_public" title="公开信件" value="1" checked>
                            </br>
                            </br>
                            <button onclick="send()" type="button" class="layui-btn layui-btn-lg">发送信件</button>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="layui-footer">
            <!-- 底部固定区域 -->
            © Rowenci.com
        </div>

        <div id="conf">
            <div id="conf_isPublic"></div>
            <div id="conf_sendTime"></div>
            <div id="conf_target"></div>
        </div>

        <script src="../../js/layui/layui.js"></script>
        <script type="text/javascript" src="../../js/jquery-3.4.0.js"></script>
        <script>

            //获取token  根据token向服务器请求数据
            var storage = window.sessionStorage;
            var token = storage.getItem("token");
            var userId = "34238374713833198854";
            //var userId = storage.getItem("userId") + "";


            var editor;
            var layedit;
            //富文本编辑器
            layui.use('layedit', function () {
                layedit = layui.layedit;
                layedit.set({
                    uploadImage: {
                        url: 'http://localhost:8080/timemachine/message/uploadImage' //接口url
                        , type: 'post' //默认post
                    }
                });
                editor = layedit.build('message', {
                    height: 500
                }); //建立编辑器
            });

            //JavaScript代码区域
            layui.use('element', function () {
                var element = layui.element;
            });

            layui.use('laydate', function () {
                var laydate = layui.laydate;
                laydate.render({
                    elem: '#vip_send'
                    , format: 'yyyy-MM-dd'
                });
            })

            //获取信息
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/timemachine/user/" + userId,
                data: {
                    "token": token
                },
                async: false,
                cache: false,
                success: function (data) {
                    if (JSON.parse(data).result == "success") {
                        $("#head_image").attr("src", JSON.parse(data).data.image);
                        $("#username").text(JSON.parse(data).data.account);
                    } else {
                        alert(JSON.parse(data).description);
                    }
                },
                error: function () {
                    alert("系统错误");
                }
            });
            //获取会员信息
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/timemachine/vip-user/check/",
                data: {
                    "token": token,
                    "userId": userId
                },
                async: false,
                cache: false,
                success: function (data) {
                    if (JSON.parse(data).data == 0) {
                        //不是会员
                        $("#show_vip_option").attr("class", "layui-btn layui-btn-disabled");
                        $("#show_vip_option").attr("onclick", "");
                    } else if (JSON.parse(data).data == 1) {
                        //是会员
                    } else {
                        alert(JSON.parse(data).description)
                    }
                },
                error: function () {
                    alert("系统错误");
                    $("#show_vip_option").attr("class", "layui-btn layui-btn-disabled");
                    $("#show_vip_option").attr("onclick", "");
                }
            });
            function show_vip_option() {
                $("#time").css("display", "none");
                $("#vip_time").css("display", "inline");
            }
            function back_vip_option() {
                $("#vip_time").css("display", "none");
                $("#time").css("display", "inline");
                $("#vip_send").val("");
            }
            function logout() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:8080/timemachine/user/logOut/",
                    data: {
                        "token": token
                    },
                    async: false,
                    cache: false,
                    success: function (data) {
                        if (JSON.parse(data).result == "success") {
                            storage.clear();
                            window.location.href = "../index.html";
                        } else {
                            alert(JSON.parse(data).description);
                        }
                    },
                    error: function () {
                        alert("系统错误");
                    }
                });
            }

            function send() {
                if ($("#email").val() == "") {
                    alert("邮箱不能为空");
                    return false;
                }
                var email = $("#email").val();
                if (!email.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/)) {
                    alert("邮箱格式不正确！请重新输入");
                    $("#email").focus();
                    return false;
                }
                if(layedit.getContent(editor) == ""){
                    alert("请不要发送空白信件");
                    return false;
                }
                //富文本编辑器出来的是html
                var message = new Object();
                message.userId = userId;
                if ($("#title").val() == "") {
                    message.title = "给未来的一封信"
                } else {
                    message.title = $("#title").val();
                }
                message.context = layedit.getContent(editor);
                message.means = 1;
                message.target = $("#email").val();

                //如果是会员
                if ($("#time").css("display") == "none" && $("#vip_time").css("display") == "inline") {
                    message.sendTime = layui.$("#vip_send").val();
                    if (message.sendTime == "" || message.sendTime == undefined) {
                        alert("请选择发送日期");
                        return;
                    }
                } else {
                    //如果是普通用户
                    $("#vip_time").css("display") == "none" && $("#time").css("display") == "inline"
                    var send_date = new Date();
                    var time = $("#time input[name='time']:checked").val();
                    //判断是否在前面加0
                    function getNow(s) {
                        return s < 10 ? '0' + s : s;
                    }
                    switch (time) {
                        case "week":
                            send_date.setDate(send_date.getDate() + 7);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                        case "month":
                            send_date.setDate(send_date.getDate() + 30);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                        case "three_month":
                            send_date.setDate(send_date.getDate() + 90);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                        case "half_year":
                            send_date.setDate(send_date.getDate() + 180);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                        case "year":
                            send_date.setDate(send_date.getDate() + 365);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                        default:
                            send_date.setDate(send_date.getDate() + 7);
                            message.sendTime = send_date.getFullYear() + "-" + getNow(send_date.getMonth() + 1) + "-" + getNow(send_date.getDate());
                            break;
                    }
                }
                var date = new Date();

                //判断是否在前面加0
                function getNow(s) {
                    return s < 10 ? '0' + s : s;
                }

                var myDate = new Date();

                var year = myDate.getFullYear();        //获取当前年
                var month = myDate.getMonth() + 1;   //获取当前月
                var date = myDate.getDate();            //获取当前日


                var h = myDate.getHours();              //获取当前小时数(0-23)
                var m = myDate.getMinutes();          //获取当前分钟数(0-59)
                var s = myDate.getSeconds();

                var now = year + '-' + getNow(month) + "-" + getNow(date) + " " + getNow(h) + ':' + getNow(m) + ":" + getNow(s);
                message.writeTime = now;
                if ($("#is_public  input[name='is_public']:checked").val() == undefined) {
                    message.isPublic = 0;
                } else {
                    message.isPublic = 1;
                }

                var messageId;

                var public = message.isPublic;
                if (public == 0) {
                    public = "否";
                } else if (public == 1) {
                    public = "是";
                }

                $("#conf_isPublic").text("是否公开：" + public);
                $("#conf_sendTime").text("发送时间：" + message.sendTime);
                $("#conf_target").text("邮箱地址：" + $("#email").val());


                layer.confirm('', { title: "请检查您的邮件发送信息", content: $("#conf").html() }, function (index) {
                    //do something
                    $.ajax({
                        type: "POST",
                        url: "http://localhost:8080/timemachine/message/",
                        data: {
                            "token": token,
                            "userId": message.userId,
                            "title": message.title,
                            "context": message.context,
                            "means": message.means,
                            "target": message.target,
                            "sendTime": message.sendTime,
                            "writeTime": message.writeTime,
                            "isPublic": message.isPublic
                        },
                        async: false,
                        cache: false,
                        success: function (data) {
                            if (JSON.parse(data).result == "success") {
                                messageId = JSON.parse(data).data.messageId;
                            } else {
                                alert(JSON.parse(data).description);
                            }
                        },
                        error: function () {
                            alert("系统错误");
                        }
                    });
                    if (message.isPublic == 1) {
                        $.ajax({
                            type: "POST",
                            url: "http://localhost:8080/timemachine/public-message/",
                            data: {
                                "userId": userId,
                                "messageId": messageId
                            },
                            async: false,
                            cache: false,
                            success: function (data) {
                                if (JSON.parse(data).result == "success") {
                                    alert("添加信件成功，请前往信件列表查看");
                                    location.reload();
                                } else {
                                    alert(JSON.parse(data).description);
                                }
                            },
                            error: function () {
                                alert("系统错误");
                            }
                        });
                    } else {
                        alert("添加信件成功，请前往信件列表查看");
                        location.reload();
                    }
                    layer.close(index);
                });
            }
        </script>
</body>

</html>