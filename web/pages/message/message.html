<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>TimeMachine - Rowenci</title>
    <link rel="stylesheet" href="../../js/layui/css/layui.css">
</head>

<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">


        <div class="layui-header">
            <div class="layui-logo">TimeMachine</div>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item">
                    <a href="javascript:;">
                        <img id="head_image" src="" class="layui-nav-img">
                        <span id="username"></span>
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="../user/userinfo.html">基本资料</a></dd>
                        <dd><a href="">安全设置</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="" onclick="logout()">退出</a></li>
            </ul>
        </div>


        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <ul class="layui-nav layui-nav-tree" lay-filter="test">
                    <li class="layui-nav-item"><a href="../public_area.html">公共区域</a></li>
                    <li class="layui-nav-item layui-nav-itemed">
                        <a class="" href="javascript:;">我的信件</a>
                        <dl class="layui-nav-child">
                            <dd class="layui-this"><a href="javascript:;">写信件</a></dd>
                            <dd><a href="./list.html">信件列表</a></dd>
                            <dd><a href="./public_list.html">公开信件</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">我的喜欢</a>
                        <dl class="layui-nav-child">
                            <dd><a href="../myfavorite/good_list.html">点赞列表</a></dd>
                            <dd><a href="../myfavorite/favorite_list.html">收藏列表</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item"><a href="">点击赞助</a></li>
                </ul>
            </div>
        </div>

        <div class="layui-body">
            <!-- 内容主体区域 -->
            <div class="layui-form-item" style="margin-top: 15px;">
                <label class="layui-form-label">信件标题：</label>
                <div class="layui-input-block">
                    <input id="title" type="text" name="title" lay-verify="title" autocomplete="off"
                        placeholder="给未来的一封信" class="layui-input">
                </div>
            </div>
            <textarea id="message" style="display: none;"></textarea>
            <div id="options">
                <fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px; height: 250px;">
                    <legend>信件选项</legend>
                    <div class="layui-form">
                        <div id="time" style="margin: 10px 0 0 25px;">
                            发送至 ：
                            <input id="week" type="radio" name="time" value="week" title="一周后" checked>
                            <input id="month" type="radio" name="time" value="month" title="一月后">
                            <input id="three_month" type="radio" name="time" value="three_month" title="三月后">
                            <input id="half_year" type="radio" name="time" value="half_year" title="半年后">
                            <input id="year" type="radio" name="time" value="year" title="一年后">
                        </div>
                        </br>
                        <div class="layui-inline">
                            <label class="layui-form-label">邮箱地址：</label>
                            <div class="layui-input-inline">
                                <input id="email" type="text" name="email" lay-verify="email" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                        </br>
                        </br>
                        <div id="is_public" style="margin-left: 25px;">
                            <input type="checkbox" name="is_public" title="公开信件" value="1" checked>
                            </br>
                            </br>
                            <button onclick="send()" type="button" class="layui-btn layui-btn-lg">发送信件</button>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="layui-footer">
            <!-- 底部固定区域 -->
            © Rowenci.com
        </div>

        <script src="../../js/layui/layui.js"></script>
        <script type="text/javascript" src="../../js/jquery-3.4.0.js"></script>
        <script>

            //获取token  根据token向服务器请求数据
            var storage = window.sessionStorage;
            var token = storage.getItem("token");
            var userId = 1;
            //var userId = storage.getItem("userId");


            var editor;
            var layedit;
            //富文本编辑器
            layui.use('layedit', function () {
                layedit = layui.layedit;
                layedit.set({
                    uploadImage: {
                        url: 'http://localhost:8080/timemachine/message/uploadImage' //接口url
                        , type: 'post' //默认post
                    }
                });
                editor = layedit.build('message', {
                    height: 500
                }); //建立编辑器
            });

            //JavaScript代码区域
            layui.use('element', function () {
                var element = layui.element;
            });

            //获取信息
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/timemachine/user/" + userId,
                data: {
                    "token": token
                },
                async: false,
                cache: false,
                success: function (data) {
                    if (JSON.parse(data).result == "success") {
                        $("#head_image").attr("src", JSON.parse(data).data.image);
                        $("#username").text(JSON.parse(data).data.account);
                    } else {
                        alert(JSON.parse(data).description);
                    }
                },
                error: function () {
                    alert("系统错误");
                }
            });
            function logout() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:8080/timemachine/user/logOut/",
                    data: {
                        "token": token
                    },
                    async: false,
                    cache: false,
                    success: function (data) {
                        if (JSON.parse(data).result == "success") {
                            storage.clear();
                            window.location.href = "../index.html";
                        } else {
                            alert(JSON.parse(data).description);
                        }
                    },
                    error: function () {
                        alert("系统错误");
                    }
                });
            }

            function send() {
                //富文本编辑器出来的是html
                console.log(layedit.getContent(editor));

                var message = new Object();
                message.userId = userId;
                if ($("#title").val() == "") {
                    message.title = "给未来的一封信"
                } else {
                    message.title = $("#title").val();
                }
                message.context = layedit.getContent(editor);
                message.means = 1;
                message.target = $("#email").val();
                var send_date = new Date();
                var time = $("#time input[name='time']:checked").val();
                switch (time) {
                    case "week":
                        send_date.setDate(send_date.getDate() + 7);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                    case "month":
                        send_date.setDate(send_date.getDate() + 30);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                    case "three_month":
                        send_date.setDate(send_date.getDate() + 90);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                    case "half_year":
                        send_date.setDate(send_date.getDate() + 180);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                    case "year":
                        send_date.setDate(send_date.getDate() + 365);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                    default:
                        send_date.setDate(send_date.getDate() + 7);
                        message.sendTime = send_date.getFullYear() + "/" + (send_date.getMonth() + 1) + "/" + send_date.getDate();
                        break;
                }
                var date = new Date();
                message.writeTime = date.toLocaleDateString();
                if ($("#is_public  input[name='is_public']:checked").val() == undefined) {
                    message.isPublic = 0;
                } else {
                    message.isPublic = 1;
                }

                console.log(message);

                var messageId;
                $.ajax({
                    type: "POST",
                    url: "http://localhost:8080/timemachine/message/",
                    data: {
                        "token": token,
                        "userId": message.userId,
                        "title": message.title,
                        "context": message.context,
                        "means": message.means,
                        "target": message.target,
                        "sendTime": message.sendTime,
                        "writeTime": message.writeTime,
                        "isPublic": message.isPublic
                    },
                    async: false,
                    cache: false,
                    success: function (data) {
                        if (JSON.parse(data).result == "success") {
                            messageId = JSON.parse(data).data.messageId;
                        } else {
                            console.log(JSON.parse(data).description);
                        }
                    },
                    error: function () {
                        alert("系统错误");
                    }
                });
                if (message.isPublic == 1) {
                    $.ajax({
                        type: "POST",
                        url: "http://localhost:8080/timemachine/public-message/",
                        data: {
                            "userId": userId,
                            "messageId": messageId
                        },
                        async: false,
                        cache: false,
                        success: function (data) {
                            if (JSON.parse(data).result == "success") {
                                alert("添加信件成功，请前往信件列表查看");
                                location.reload();
                            } else {
                                alert(JSON.parse(data).description);
                            }
                        },
                        error: function () {
                            alert("系统错误");
                        }
                    });
                } else {
                    alert("添加信件成功，请前往信件列表查看");
                    location.reload();
                }

            }
        </script>
</body>

</html>