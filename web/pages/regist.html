<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>注册</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../js/layui/css/layui.css">
</head>

<body>
  <div class="layui-form" style="margin-top: 20px;">
    <div class="layui-form-item">
      <label class="layui-form-label">账号</label>
      <div class="layui-input-inline">
        <input type="text" name="username" lay-verify="required" placeholder="请输入账号" autocomplete="off"
          class="layui-input" id="account">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">密码</label>
      <div class="layui-input-inline">
        <input type="password" name="password" lay-verify="required" placeholder="请输入密码" autocomplete="off"
          class="layui-input" id="password">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">手机号码</label>
      <div class="layui-input-inline">
        <input type="text" name="username" lay-verify="required" placeholder="请输入" autocomplete="off"
          class="layui-input" id="phonenumber">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">安全问题</label>
      <div class="layui-input-block">
        <select name="city" lay-verify="" style="display: block; height: 40px; width: 190px; border: 1px solid gray;"
          id="question">
          <option value="">请选择一个问题</option>
          <option value="1">母亲的名字</option>
          <option value="2">父亲的名字</option>
          <option value="3">小学的名字</option>
        </select>
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">安全答案</label>
      <div class="layui-input-inline">
        <input type="text" name="username" lay-verify="required" placeholder="请输入" autocomplete="off"
          class="layui-input" id="answer">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">邮箱</label>
      <div class="layui-input-inline">
        <input type="text" name="username" lay-verify="required" placeholder="请输入" autocomplete="off"
          class="layui-input" id="email">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">性别</label>
      <div class="layui-input-block">
        <select name="city" lay-verify="" style="display: block; height: 40px; width: 190px; border: 1px solid gray;"
          id="sex">
          <option value="1">男</option>
          <option value="0">女</option>
        </select>
      </div>
    </div>
    <div class="layui-form-item">
      <div class="layui-inline">
        <label class="layui-form-label">出生年月</label>
        <div class="layui-input-inline">
          <input type="text" class="layui-input" id="birthday" placeholder="yyyy年MM月dd日">
        </div>
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">注册地址</label>
      <div class="layui-input-inline">
        <input type="text" name="username" lay-verify="required" placeholder="请输入" autocomplete="off"
          class="layui-input" id="location">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">头像</label>
      <div class="layui-upload">
        <div class="layui-upload-list">
          <img class="layui-upload-img" id="image_show" src="http://192.168.1.21:9001/timemachine/default.jpg"
            style="width: 100px; height: 100px;">
          <button type="button" class="layui-btn" id="image_btn">上传图片</button>
          <input style="display: none;" id="image"></input>
        </div>
      </div>
    </div>
    <button type="button" class="layui-btn layui-btn-lg" style="margin-left: 110px;" onclick="regist()">提交</button>
  </div>

  <script src="../js/layui/layui.js" charset="utf-8"></script>
  <script type="text/javascript" src="../js/jquery-3.4.0.js"></script>
  <script>
    layui.use('laydate', function () {
      var laydate = layui.laydate;
      laydate.render({
        elem: '#birthday'
        , format: 'yyyy-MM-dd'
      });
    })
    layui.use('upload', function () {
      var $ = layui.jquery
        , upload = layui.upload;

      var uploadInst = upload.render({
        elem: '#image_btn'
        , url: 'http://localhost:8080/timemachine/message/uploadImage' //改成您自己的上传接口
        , done: function (res) {
          //如果上传失败
          if (res.code < 0) {
            return layer.msg('上传失败');
          }
          //上传成功
          $('#image_show').attr('src', res.data.src)
        }
        , error: function () {
          //演示失败状态，并实现重传
          var demoText = $('#demoText');
          demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
          demoText.find('.demo-reload').on('click', function () {
            uploadInst.upload();
          });
        }
      });
    })
    function regist() {
      var user = new Object();
      user.account = $("#account").val();
      user.password = $("#password").val();
      user.phonenumber = $("#phonenumber").val();
      user.question_id = $("#question option:selected").val();
      user.answer = $("#answer").val();
      user.email = $("#email").val();
      user.sex = $("#sex option:selected").val();
      user.birthday = layui.$("#birthday").val();
      user.location = $("#location").val();
      user.image = $("#image").attr("src");
      Date.prototype.Format = function (fmt) { // author: meizz
        var o = {
          "M+": this.getMonth() + 1, // 月份
          "d+": this.getDate(), // 日
          "H+": this.getHours(), // 小时
          "m+": this.getMinutes(), // 分
          "s+": this.getSeconds(), // 秒
          "q+": Math.floor((this.getMonth() + 3) / 3), // 季度
          "S": this.getMilliseconds() // 毫秒
        };
        if (/(y+)/.test(fmt))
          fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
          if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
      }
      user.logupTime = new Date().Format("yyyy-MM-dd HH:mm:ss");
      if (user.account == "" || user.password == "" || user.birthday == "" || user.sex == "" || user.question_id == "" || user.phonenumber == "") {
        alert("请填写完整信息");
      } else {
        $.ajax({
          type: "POST",
          url: "http://localhost:8080/timemachine/user/",
          data: {
            "account": user.account,
            "password": user.password,
            "phoneNumber": user.phonenumber,
            "questionId": user.question_id,
            "answer": user.answer,
            "email": user.email,
            "sex": user.sex,
            "birthday": user.birthday,
            "location": user.location,
            "logupTime": user.logupTime,
            "image": user.image
          },
          async: false,
          cache: false,
          success: function (data) {
            if (JSON.parse(data).result == "success") {
              alert("注册成功");
              //返回到登录
            } else {
              alert("注册失败");
            }
          },
          error: function () {
            alert("系统错误");
          }
        });
      }
    }
  </script>
</body>

</html>